name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: read

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          version="${{ github.event.inputs.version }}"
          if [[ ! $version =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $version"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Version format is valid: $version"

      - name: Check if tag exists
        run: |
          version="${{ github.event.inputs.version }}"
          if git rev-parse "$version" >/dev/null 2>&1; then
            echo "âŒ Tag $version already exists"
            exit 1
          fi
          echo "âœ… Tag $version is available"

  build:
    name: Build Release Artifacts
    needs: validate
    uses: ./.github/workflows/build.yml

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-linux-x86_64
          path: ./artifacts/

      - name: Download Windows x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-windows-x86_64
          path: ./artifacts/

      - name: Download macOS x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-macos-x86_64
          path: ./artifacts/

      - name: Download macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-macos-arm64
          path: ./artifacts/

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la artifacts/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "Media Generator ${{ github.event.inputs.version }} - Embedded FFmpeg Edition"
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: artifacts/**/*
          body: |
            ## Media Generator - Embedded FFmpeg Edition

            **No external dependencies required!** FFmpeg is embedded directly into the executable.

            ### ğŸš€ What's New in ${{ github.event.inputs.version }}

            - Embedded FFmpeg binaries for all platforms
            - Zero external dependencies
            - Cross-platform support (Linux, Windows, macOS Intel/ARM)
            - Improved error handling and logging

            ### ğŸ“¥ Downloads

            | Platform | Download |
            |----------|----------|
            | **Linux x86_64** | `media-gen-linux-x86_64` |
            | **Windows x86_64** | `media-gen-windows-x86_64.exe` |
            | **macOS Intel** | `media-gen-macos-x86_64` |
            | **macOS ARM64** | `media-gen-macos-arm64` |

            ### ğŸ› ï¸ Usage

            ```bash
            # Generate video with countdown
            ./media-gen video --duration 10 --output countdown.mp4

            # Generate audio test tone
            ./media-gen audio --frequency 440 --duration 5 --output tone.wav

            # Show help
            ./media-gen help
            ```

            ### âœ¨ Features

            - ğŸ¬ **Video generation** with animated countdown timer
            - ğŸµ **Audio generation** with configurable sine wave test tones
            - ğŸ¯ **Multiple formats**: MP4, AVI, MOV, MKV, MP3, WAV, AAC, FLAC
            - ğŸ“¦ **Zero dependencies** - FFmpeg embedded
            - ğŸš€ **Cross-platform** support
            - âš¡ **Fast** - Built with Zig for optimal performance

            ### ğŸ”§ Installation

            1. Download the appropriate binary for your platform
            2. Make it executable: `chmod +x media-gen-*` (Unix systems)
            3. Run: `./media-gen help`

            No additional setup required!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
