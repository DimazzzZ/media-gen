name: Resilient Build (No External Dependencies)

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: linux,windows,macos)'
        required: false
        default: 'linux,windows,macos'
        type: string
      skip_cache:
        description: 'Skip caching (for when GitHub cache is down)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: read

jobs:
  build:
    name: Resilient Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            target: x86_64-linux
            artifact: media-gen-linux-x86_64
          - os: windows
            runner: windows-2022
            target: x86_64-windows
            artifact: media-gen-windows-x86_64.exe
          - os: macos-intel
            runner: macos-13
            target: x86_64-macos
            artifact: media-gen-macos-x86_64
          - os: macos-arm
            runner: macos-latest
            target: aarch64-macos
            artifact: media-gen-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Optional caching - skip if GitHub cache is down
      - name: Try to cache FFmpeg binaries
        if: github.event.inputs.skip_cache != 'true'
        uses: actions/cache@v4
        continue-on-error: true
        id: cache-ffmpeg
        with:
          path: src/vendor/ffmpeg
          key: ffmpeg-resilient-${{ matrix.os }}-${{ hashFiles('scripts/download-ffmpeg*') }}
          restore-keys: |
            ffmpeg-resilient-${{ matrix.os }}-

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      # Optional build caching
      - name: Try to cache Zig build
        if: github.event.inputs.skip_cache != 'true'
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-resilient-${{ matrix.os }}-${{ matrix.target }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}

      # Pre-download FFmpeg with retry logic (Windows)
      - name: Ensure FFmpeg is available (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          $maxAttempts = 3
          $attempt = 1

          while ($attempt -le $maxAttempts) {
            Write-Host "ðŸ”„ Attempt $attempt/$maxAttempts to ensure FFmpeg..."

            $ffmpegExists = (Test-Path "src\vendor\ffmpeg") -and
                             (Get-ChildItem "src\vendor\ffmpeg" -Recurse -Name "ffmpeg*").Count -gt 0
            if ($ffmpegExists) {
              Write-Host "âœ… FFmpeg already available"
              break
            }

            Write-Host "ðŸ“¥ Downloading FFmpeg (attempt $attempt)..."

            if (Test-Path "scripts\download-ffmpeg-windows.ps1") {
              powershell -ExecutionPolicy Bypass -File ".\scripts\download-ffmpeg-windows.ps1"
            } else {
              bash .\scripts\download-ffmpeg.sh
            }

            $ffmpegExists = (Test-Path "src\vendor\ffmpeg") -and
                             (Get-ChildItem "src\vendor\ffmpeg" -Recurse -Name "ffmpeg*").Count -gt 0
            if ($ffmpegExists) {
              Write-Host "âœ… FFmpeg download successful"
              break
            }

            if ($attempt -eq $maxAttempts) {
              Write-Error "âŒ Failed to download FFmpeg after $maxAttempts attempts"
              exit 1
            }

            Write-Host "â³ Waiting 10 seconds before retry..."
            Start-Sleep 10
            $attempt++
          }

      # Pre-download FFmpeg with retry logic (Unix)
      - name: Ensure FFmpeg is available (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          max_attempts=3
          attempt=1

          while [$attempt -le $max_attempts]; do
            echo "ðŸ”„ Attempt $attempt/$max_attempts to ensure FFmpeg..."

            if [-d "src/vendor/ffmpeg"] && ["$(find src/vendor/ffmpeg -name 'ffmpeg*' -type f | wc -l)" -gt 0]; then
              echo "âœ… FFmpeg already available"
              break
            fi

            echo "ðŸ“¥ Downloading FFmpeg (attempt $attempt)..."
            chmod +x ./scripts/download-ffmpeg.sh
            ./scripts/download-ffmpeg.sh

            if [-d "src/vendor/ffmpeg"] && ["$(find src/vendor/ffmpeg -name 'ffmpeg*' -type f | wc -l)" -gt 0]; then
              echo "âœ… FFmpeg download successful"
              break
            fi

            if [$attempt -eq $max_attempts]; then
              echo "âŒ Failed to download FFmpeg after $max_attempts attempts"
              exit 1
            fi

            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
            attempt=$((attempt + 1))
          done

      # Build with retry logic (Windows)
      - name: Build with retry (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          $maxAttempts = 2
          $attempt = 1

          while ($attempt -le $maxAttempts) {
            Write-Host "ðŸ”¨ Build attempt $attempt/$maxAttempts..."

            $env:ZIG_GLOBAL_CACHE_DIR = "$env:RUNNER_TEMP\zig-cache"
            zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe --parallel

            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… Build successful"
              break
            }

            if ($attempt -eq $maxAttempts) {
              Write-Error "âŒ Build failed after $maxAttempts attempts"
              exit 1
            }

            Write-Host "â³ Cleaning cache and retrying..."
            Remove-Item ".zig-cache", "zig-out" -Recurse -Force -ErrorAction SilentlyContinue
            $attempt++
          }

      # Build with retry logic (Unix)
      - name: Build with retry (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          max_attempts=2
          attempt=1

          while [$attempt -le $max_attempts]; do
            echo "ðŸ”¨ Build attempt $attempt/$max_attempts..."

            zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe

            if [$? -eq 0]; then
              echo "âœ… Build successful"
              break
            fi

            if [$attempt -eq $max_attempts]; then
              echo "âŒ Build failed after $max_attempts attempts"
              exit 1
            fi

            echo "â³ Cleaning cache and retrying..."
            rm -rf .zig-cache zig-out 2>/dev/null || true
            attempt=$((attempt + 1))
          done

      - name: Verify and copy artifact (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          if (Test-Path "zig-out\bin\media-gen.exe") {
            Copy-Item "zig-out\bin\media-gen.exe" "${{ matrix.artifact }}" -Force
            $fileInfo = Get-Item "${{ matrix.artifact }}"
            Write-Host "âœ… Windows artifact: $($fileInfo.Length) bytes"
          } else {
            Write-Error "âŒ Windows executable not found"
            exit 1
          }

      - name: Verify and copy artifact (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          if [-f "zig-out/bin/media-gen"]; then
            cp zig-out/bin/media-gen ${{ matrix.artifact }}
            ls -la ${{ matrix.artifact }}
            echo "âœ… Unix artifact created"
          else
            echo "âŒ Unix executable not found"
            exit 1
          fi

      # Try to upload, but don't fail if it doesn't work
      - name: Try to upload artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ matrix.artifact }}-resilient
          path: ${{ matrix.artifact }}
          retention-days: 7

      # Always show build success info (Windows)
      - name: Build summary (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          Write-Host "ðŸŽ‰ Build completed successfully!"
          Write-Host "Platform: ${{ matrix.os }}"
          Write-Host "Target: ${{ matrix.target }}"
          Write-Host "Artifact: ${{ matrix.artifact }}"
          if (Test-Path "${{ matrix.artifact }}") {
            $size = (Get-Item "${{ matrix.artifact }}").Length
            Write-Host "Size: $([math]::Round($size / 1MB, 2)) MB"
          }

      # Always show build success info (Unix)
      - name: Build summary (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          echo "ðŸŽ‰ Build completed successfully!"
          echo "Platform: ${{ matrix.os }}"
          echo "Target: ${{ matrix.target }}"
          echo "Artifact: ${{ matrix.artifact }}"
          if [-f "${{ matrix.artifact }}"]; then
            size=$(stat -c%s "${{ matrix.artifact }}" 2>/dev/null || stat -f%z "${{ matrix.artifact }}")
            echo "Size: $(echo "scale=2; $size / 1048576" | bc 2>/dev/null || echo "$size bytes")"
          fi

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Build Results Summary
        run: |
          echo "## Resilient Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This build works even when GitHub services have issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No dependency on GitHub cache service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Retry logic for downloads and builds" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Continues even if artifact upload fails" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Independent platform builds (fail-fast: false)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status:" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results above for platform-specific outcomes." >> $GITHUB_STEP_SUMMARY
