name: Windows Build (Optimized)

on:
  workflow_dispatch:
    inputs:
      optimize_level:
        description: 'Optimization level'
        required: false
        default: 'ReleaseSafe'
        type: choice
        options:
          - Debug
          - ReleaseSafe
          - ReleaseFast
          - ReleaseSmall

permissions:
  contents: read
  packages: read

jobs:
  windows-build:
    name: Optimized Windows Build
    runs-on: windows-2022
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Multi-layer caching strategy for Windows
      - name: Cache FFmpeg binaries (Windows)
        uses: actions/cache@v4
        with:
          path: src/vendor/ffmpeg
          key: ffmpeg-win-${{ hashFiles('scripts/download-ffmpeg.sh') }}-v2
          restore-keys: |
            ffmpeg-win-v2
            ffmpeg-win-

      - name: Cache Zig toolchain (Windows)
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\zig
            C:\hostedtoolcache\windows\zig
          key: zig-toolchain-win-0.15.1-v2
          restore-keys: |
            zig-toolchain-win-0.15.1-
            zig-toolchain-win-

      - name: Setup Zig (Cached)
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
            ${{ runner.temp }}\zig-cache
          key: zig-build-win-${{ github.event.inputs.optimize_level || 'ReleaseSafe' }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}-v2
          restore-keys: |
            zig-build-win-${{ github.event.inputs.optimize_level || 'ReleaseSafe' }}-
            zig-build-win-

      # Windows-specific environment optimization
      - name: Configure Windows build environment
        shell: pwsh
        run: |
          # Set optimal environment variables
          echo "ZIG_GLOBAL_CACHE_DIR=$env:RUNNER_TEMP\zig-global-cache" >> $env:GITHUB_ENV
          echo "ZIG_LOCAL_CACHE_DIR=.zig-cache" >> $env:GITHUB_ENV
          
          # Use all CPU cores for parallel compilation
          $cpuCores = (Get-WmiObject -Class Win32_ComputerSystem).NumberOfLogicalProcessors
          echo "ZIG_BUILD_JOBS=$cpuCores" >> $env:GITHUB_ENV
          echo "NUMBER_OF_PROCESSORS=$cpuCores" >> $env:GITHUB_ENV
          
          # Set Windows-specific compiler flags
          echo "ZIG_FLAGS=--cache-dir $env:RUNNER_TEMP\zig-cache" >> $env:GITHUB_ENV
          
          Write-Host "üöÄ Configured for $cpuCores CPU cores"
          Write-Host "üìÅ Cache dir: $env:RUNNER_TEMP\zig-cache"

      # Pre-download FFmpeg if not cached
      - name: Pre-download FFmpeg (if needed)
        shell: pwsh
        run: |
          if (-not (Test-Path "src\vendor\ffmpeg")) {
            Write-Host "üì• FFmpeg not cached, pre-downloading..."
            # Use PowerShell for faster download on Windows
            New-Item -ItemType Directory -Force -Path "src\vendor\ffmpeg\windows-x64"
            
            # Download directly with PowerShell (faster than bash on Windows)
            $url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
            $output = "$env:TEMP\ffmpeg-win64.zip"
            
            Write-Host "‚¨áÔ∏è Downloading FFmpeg for Windows..."
            Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
            
            Write-Host "üì¶ Extracting FFmpeg..."
            Expand-Archive -Path $output -DestinationPath "$env:TEMP\ffmpeg-extract" -Force
            
            # Find and copy the FFmpeg executable
            $ffmpegExe = Get-ChildItem -Path "$env:TEMP\ffmpeg-extract" -Name "ffmpeg.exe" -Recurse | Select-Object -First 1
            if ($ffmpegExe) {
              $sourcePath = "$env:TEMP\ffmpeg-extract\$ffmpegExe"
              Copy-Item $sourcePath "src\vendor\ffmpeg\windows-x64\ffmpeg.exe" -Force
              Write-Host "‚úÖ FFmpeg ready for Windows build"
            }
            
            # Cleanup
            Remove-Item $output -Force -ErrorAction SilentlyContinue
            Remove-Item "$env:TEMP\ffmpeg-extract" -Recurse -Force -ErrorAction SilentlyContinue
          } else {
            Write-Host "‚úÖ FFmpeg already cached"
          }

      # Optimized build with parallel compilation
      - name: Build Windows executable (Optimized)
        shell: pwsh
        run: |
          $optimizeLevel = "${{ github.event.inputs.optimize_level }}" -or "ReleaseSafe"
          Write-Host "üî® Building with optimization: $optimizeLevel"
          
          # Measure build time
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          
          # Build with optimal flags
          zig build -Dtarget=x86_64-windows -Doptimize=$optimizeLevel --cache-dir "$env:RUNNER_TEMP\zig-cache" --parallel
          
          $stopwatch.Stop()
          $buildTime = $stopwatch.Elapsed.TotalSeconds
          Write-Host "‚ö° Build completed in $([math]::Round($buildTime, 2)) seconds"
          
          # Verify output
          if (Test-Path "zig-out\bin\media-gen.exe") {
            $fileSize = (Get-Item "zig-out\bin\media-gen.exe").Length
            Write-Host "‚úÖ Windows executable created: $([math]::Round($fileSize / 1MB, 2)) MB"
          } else {
            Write-Error "‚ùå Build failed - executable not found"
            exit 1
          }

      # Quick functionality test
      - name: Quick Windows test
        shell: pwsh
        run: |
          Write-Host "üß™ Running quick functionality test..."
          
          # Test help command
          .\zig-out\bin\media-gen.exe help
          
          # Quick media generation test
          New-Item -ItemType Directory -Force -Path "test-output"
          
          Write-Host "üìπ Testing video generation..."
          .\zig-out\bin\media-gen.exe video --duration 1 --width 160 --height 120 --output "test-output\test.mp4"
          
          Write-Host "üéµ Testing audio generation..."
          .\zig-out\bin\media-gen.exe audio --duration 1 --sample-rate 8000 --output "test-output\test.mp3"
          
          # Verify outputs
          if ((Test-Path "test-output\test.mp4") -and (Test-Path "test-output\test.mp3")) {
            $videoSize = (Get-Item "test-output\test.mp4").Length
            $audioSize = (Get-Item "test-output\test.mp3").Length
            Write-Host "‚úÖ Tests passed - Video: $videoSize bytes, Audio: $audioSize bytes"
          } else {
            Write-Error "‚ùå Functionality test failed"
            exit 1
          }

      - name: Prepare Windows artifact
        shell: pwsh
        run: |
          Copy-Item "zig-out\bin\media-gen.exe" "media-gen-windows-x86_64.exe" -Force
          
          # Get file info
          $fileInfo = Get-Item "media-gen-windows-x86_64.exe"
          Write-Host "üì¶ Final artifact: $($fileInfo.Name) ($([math]::Round($fileInfo.Length / 1MB, 2)) MB)"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: media-gen-windows-optimized
          path: media-gen-windows-x86_64.exe
          retention-days: 7

      # Performance summary
      - name: Build performance summary
        shell: pwsh
        run: |
          Write-Host "üéØ Windows Build Performance Summary:"
          Write-Host "- Optimization level: ${{ github.event.inputs.optimize_level || 'ReleaseSafe' }}"
          Write-Host "- CPU cores used: $env:NUMBER_OF_PROCESSORS"
          Write-Host "- Cache strategy: Multi-layer (FFmpeg + Zig + Build)"
          Write-Host "- Shell: PowerShell (native Windows)"
          Write-Host "- Runner: windows-2022"