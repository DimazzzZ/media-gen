name: Validate Workflows

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: Validate GitHub Actions Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          echo "Validating workflow files..."

          # Check if workflow files are valid YAML
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              python3 -c "
          import yaml
          import sys
          try:
              with open('$file', 'r') as f:
                  yaml.safe_load(f)
              print('✅ $file is valid YAML')
          except yaml.YAMLError as e:
              print('❌ $file has YAML syntax error:', e)
              sys.exit(1)
          except Exception as e:
              print('❌ Error reading $file:', e)
              sys.exit(1)
              "
            fi
          done

      - name: Check for required fields
        run: |
          echo "Checking for required fields..."

          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file for required fields..."

              if ! grep -q "^name:" "$file"; then
                echo "❌ $file is missing 'name' field"
                exit 1
              fi

              if ! grep -q "^on:" "$file"; then
                echo "❌ $file is missing 'on' field"
                exit 1
              fi

              if ! grep -q "^jobs:" "$file"; then
                echo "❌ $file is missing 'jobs' field"
                exit 1
              fi

              echo "✅ $file has required fields"
            fi
          done

      - name: Check script permissions
        run: |
          echo "Checking script permissions..."

          if [ -f "scripts/download-ffmpeg.sh" ]; then
            if [ -x "scripts/download-ffmpeg.sh" ]; then
              echo "✅ download-ffmpeg.sh is executable"
            else
              echo "❌ download-ffmpeg.sh is not executable"
              exit 1
            fi
          else
            echo "❌ download-ffmpeg.sh not found"
            exit 1
          fi

  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check action versions
        run: |
          echo "Checking GitHub Actions versions..."

          # List all used actions
          echo "Used actions:"
          grep -r "uses:" .github/workflows/ | grep -v "^#" | sort | uniq

          # Check for unpinned actions
          if grep -r "uses:.*@main\|uses:.*@master" .github/workflows/; then
            echo "⚠️  Found unpinned actions (consider using specific versions)"
          fi

      - name: Validate build requirements
        run: |
          echo "Validating build requirements..."

          # Check if Zig setup is present
          if grep -r "setup-zig" .github/workflows/; then
            echo "✅ Zig setup found in workflows"
          else
            echo "❌ Zig setup not found in workflows"
            exit 1
          fi

          echo "✅ All dependencies validated"
