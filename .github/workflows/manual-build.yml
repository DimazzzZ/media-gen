name: Manual Build

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Select platforms to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - macos
          - linux,windows
          - linux,macos
          - windows,macos
      optimize:
        description: 'Optimization level'
        required: true
        default: 'ReleaseSafe'
        type: choice
        options:
          - Debug
          - ReleaseSafe
          - ReleaseFast
          - ReleaseSmall

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          platforms="${{ github.event.inputs.platforms }}"

          if ["$platforms" = "all"]; then
            platforms="linux,windows,macos"
          fi

          matrix_items=()

          if [["$platforms" == *"linux"*]]; then
            matrix_items+=('{"os":"linux","runner":"ubuntu-latest","target":"x86_64-linux","artifact":"media-gen-linux-x86_64"}')
          fi

          if [["$platforms" == *"windows"*]]; then
            matrix_items+=('{"os":"windows","runner":"windows-latest","target":"x86_64-windows","artifact":"media-gen-windows-x86_64.exe"}')
          fi

          if [["$platforms" == *"macos"*]]; then
            matrix_items+=('{"os":"macos-intel","runner":"macos-13","target":"x86_64-macos","artifact":"media-gen-macos-x86_64"}')
            matrix_items+=('{"os":"macos-arm","runner":"macos-latest","target":"aarch64-macos","artifact":"media-gen-macos-arm64"}')
          fi

          matrix_json=$(printf '%s\n' "${matrix_items[@]}" | jq -s .)
          echo "matrix={\"include\":$matrix_json}" >> $GITHUB_OUTPUT

  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    needs: prepare
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Build for ${{ matrix.target }} (FFmpeg embedded automatically)
        run: zig build -Dtarget=${{ matrix.target }} -Doptimize=${{ github.event.inputs.optimize }}

      - name: Copy artifact (Unix)
        if: matrix.os != 'windows'
        run: cp zig-out/bin/media-gen ${{ matrix.artifact }}

      - name: Copy artifact (Windows)
        if: matrix.os == 'windows'
        run: copy zig-out\bin\media-gen.exe ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}
          retention-days: 7
