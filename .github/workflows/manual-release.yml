name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: read

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          version="${{ github.event.inputs.version }}"
          if [[ ! $version =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $version"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "‚úÖ Version format is valid: $version"

      - name: Check if tag exists
        run: |
          version="${{ github.event.inputs.version }}"
          if git rev-parse "$version" >/dev/null 2>&1; then
            echo "‚ùå Tag $version already exists"
            exit 1
          fi
          echo "‚úÖ Tag $version is available"

  build:
    name: Build Release Artifacts
    needs: validate
    uses: ./.github/workflows/build.yml

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Download Bundled Edition artifacts
      - name: Download Bundled Linux x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-bundled-linux-x86_64
          path: ./artifacts/bundled/

      - name: Download Bundled Windows x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-bundled-windows-x86_64.exe
          path: ./artifacts/bundled/

      - name: Download Bundled macOS x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-bundled-macos-x86_64
          path: ./artifacts/bundled/

      - name: Download Bundled macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-bundled-macos-arm64
          path: ./artifacts/bundled/

      # Download Standalone Edition artifacts
      - name: Download Standalone Linux x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-standalone-linux-x86_64
          path: ./artifacts/standalone/

      - name: Download Standalone Windows x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-standalone-windows-x86_64.exe
          path: ./artifacts/standalone/

      - name: Download Standalone macOS x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-standalone-macos-x86_64
          path: ./artifacts/standalone/

      - name: Download Standalone macOS ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: media-gen-standalone-macos-arm64
          path: ./artifacts/standalone/

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          echo "=== Bundled Edition ==="
          ls -la artifacts/bundled/
          echo "=== Standalone Edition ==="
          ls -la artifacts/standalone/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "Media Generator ${{ github.event.inputs.version }}"
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            artifacts/bundled/*
            artifacts/standalone/*
          body: |
            ## Media Generator ${{ github.event.inputs.version }}

            ### üì¶ Two Editions Available

            | Edition | Description | Size | Dependencies |
            |---------|-------------|------|--------------|
            | **Bundled** | FFmpeg embedded in binary | ~80MB+ | None |
            | **Standalone** | Uses system FFmpeg | ~1MB | Requires FFmpeg |

            ---

            ### üöÄ Bundled Edition (Recommended for most users)

            **No external dependencies required!** FFmpeg is embedded directly into the executable.

            | Platform | Download |
            |----------|----------|
            | **Linux x86_64** | `media-gen-bundled-linux-x86_64` |
            | **Windows x86_64** | `media-gen-bundled-windows-x86_64.exe` |
            | **macOS Intel** | `media-gen-bundled-macos-x86_64` |
            | **macOS ARM64** | `media-gen-bundled-macos-arm64` |

            ---

            ### üîß Standalone Edition (For users who have FFmpeg installed)

            **Smaller binary size!** Requires FFmpeg to be installed on your system.

            | Platform | Download |
            |----------|----------|
            | **Linux x86_64** | `media-gen-standalone-linux-x86_64` |
            | **Windows x86_64** | `media-gen-standalone-windows-x86_64.exe` |
            | **macOS Intel** | `media-gen-standalone-macos-x86_64` |
            | **macOS ARM64** | `media-gen-standalone-macos-arm64` |

            **Installing FFmpeg:**
            - macOS: `brew install ffmpeg`
            - Linux: `apt install ffmpeg` or `dnf install ffmpeg`
            - Windows: `choco install ffmpeg` or `winget install ffmpeg`

            ---

            ### üõ†Ô∏è Usage

            ```bash
            # Generate video with countdown
            ./media-gen video --duration 10 --output countdown.mp4

            # Generate audio test tone
            ./media-gen audio --frequency 440 --duration 5 --output tone.wav

            # Show help
            ./media-gen help
            ```

            ### ‚ú® Features

            - üé¨ **Video generation** with animated countdown timer
            - üéµ **Audio generation** with configurable sine wave test tones
            - üéØ **Multiple formats**: MP4, AVI, MOV, MKV, MP3, WAV, AAC, FLAC
            - üöÄ **Cross-platform** support (Linux, Windows, macOS Intel/ARM)
            - ‚ö° **Fast** - Built with Zig for optimal performance

            ### üîß Installation

            1. Download the appropriate binary for your platform and preferred edition
            2. Make it executable: `chmod +x media-gen-*` (Unix systems)
            3. Run: `./media-gen-* help`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
