name: Test Suite

on:
  workflow_run:
    workflows: ["Quick Tests"]
    types: [completed]
    branches: [main, develop]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
      edition:
        description: 'Edition to test'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - bundled
          - standalone

jobs:
  validate:
    name: Validate Workflows
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate workflow syntax
        run: |
          echo "✅ Basic workflow validation passed"

      - name: Check script permissions
        run: |
          if [ -f "scripts/download-ffmpeg.sh" ]; then
            echo "✅ download-ffmpeg.sh found"
          else
            echo "❌ download-ffmpeg.sh not found"
            exit 1
          fi

  # ==========================================================================
  # Unit Tests - Bundled Edition
  # ==========================================================================
  unit-tests-bundled:
    name: Unit Tests - Bundled Edition
    runs-on: ubuntu-latest
    if: >
      (github.event.inputs.edition != 'standalone') &&
      (github.event.inputs.test_type == 'all' ||
       github.event.inputs.test_type == 'unit' ||
       github.event_name == 'schedule' ||
       github.event_name == 'workflow_run')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache FFmpeg binaries
        uses: actions/cache@v4
        with:
          path: src/vendor/ffmpeg
          key: ffmpeg-binaries-${{ runner.os }}-v1
          restore-keys: |
            ffmpeg-binaries-${{ runner.os }}-

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-build-bundled-${{ runner.os }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}
          restore-keys: |
            zig-build-bundled-${{ runner.os }}-

      - name: Run unit tests (bundled)
        run: zig build test

      - name: Generate test coverage
        run: |
          zig build test --summary all 2>&1 | tee test_output.txt
          echo "## Test Results - Bundled Edition" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Unit Tests - Standalone Edition
  # ==========================================================================
  unit-tests-standalone:
    name: Unit Tests - Standalone Edition
    runs-on: ubuntu-latest
    if: >
      (github.event.inputs.edition != 'bundled') &&
      (github.event.inputs.test_type == 'all' ||
       github.event.inputs.test_type == 'unit' ||
       github.event_name == 'schedule' ||
       github.event_name == 'workflow_run')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-build-standalone-${{ runner.os }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}
          restore-keys: |
            zig-build-standalone-${{ runner.os }}-

      - name: Run unit tests (standalone)
        run: zig build test -Dno-embed-ffmpeg=true

      - name: Generate test coverage
        run: |
          zig build test -Dno-embed-ffmpeg=true --summary all 2>&1 | tee test_output.txt
          echo "## Test Results - Standalone Edition" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Integration Tests - Bundled Edition
  # ==========================================================================
  integration-tests-bundled:
    name: Integration Tests - Bundled ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    if: >
      (github.event.inputs.edition != 'standalone') &&
      (github.event.inputs.test_type == 'all' ||
       github.event.inputs.test_type == 'integration' ||
       github.event_name == 'schedule' ||
       github.event_name == 'workflow_run')
    strategy:
      matrix:
        include:
          - os: ubuntu
            runner: ubuntu-latest
            shell: bash
          - os: windows
            runner: windows-2022
            shell: pwsh
          - os: macos
            runner: macos-latest
            shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache FFmpeg binaries
        uses: actions/cache@v4
        with:
          path: src/vendor/ffmpeg
          key: ffmpeg-binaries-${{ matrix.os }}-v1
          restore-keys: |
            ffmpeg-binaries-${{ matrix.os }}-

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Windows build dependencies
        if: matrix.os == 'windows'
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Temp\zig-*
            ~\AppData\Local\zig
          key: windows-test-deps-bundled-${{ hashFiles('build.zig') }}

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-build-bundled-${{ matrix.os }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}
          restore-keys: |
            zig-build-bundled-${{ matrix.os }}-

      - name: Build application (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: zig build

      - name: Build application (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: zig build

      - name: Test video generation
        shell: bash
        run: |
          mkdir -p test-media
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen.exe video --duration 1 --width 320 --height 240 --output test-media/test_video.mp4
          else
            ./zig-out/bin/media-gen video --duration 1 --width 320 --height 240 --output test-media/test_video.mp4
          fi
          if [[ ! -f test-media/test_video.mp4 ]]; then
            echo "Video file was not created"
            exit 1
          fi
          file_size=$(stat -f%z test-media/test_video.mp4 2>/dev/null || stat -c%s test-media/test_video.mp4)
          if [[ $file_size -lt 1000 ]]; then
            echo "Video file is too small: $file_size bytes"
            exit 1
          fi
          echo "✅ Bundled video test passed: $file_size bytes"

      - name: Test audio generation
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen.exe audio --duration 1 --sample-rate 22050 --output test-media/test_audio.mp3
          else
            ./zig-out/bin/media-gen audio --duration 1 --sample-rate 22050 --output test-media/test_audio.mp3
          fi
          if [[ ! -f test-media/test_audio.mp3 ]]; then
            echo "Audio file was not created"
            exit 1
          fi
          file_size=$(stat -f%z test-media/test_audio.mp3 2>/dev/null || stat -c%s test-media/test_audio.mp3)
          if [[ $file_size -lt 1000 ]]; then
            echo "Audio file is too small: $file_size bytes"
            exit 1
          fi
          echo "✅ Bundled audio test passed: $file_size bytes"

      - name: Test help command
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen.exe help
          else
            ./zig-out/bin/media-gen help
          fi

  # ==========================================================================
  # Integration Tests - Standalone Edition
  # ==========================================================================
  integration-tests-standalone:
    name: Integration Tests - Standalone ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    if: >
      (github.event.inputs.edition != 'bundled') &&
      (github.event.inputs.test_type == 'all' ||
       github.event.inputs.test_type == 'integration' ||
       github.event_name == 'schedule' ||
       github.event_name == 'workflow_run')
    strategy:
      matrix:
        include:
          - os: ubuntu
            runner: ubuntu-latest
            shell: bash
          - os: windows
            runner: windows-2022
            shell: pwsh
          - os: macos
            runner: macos-latest
            shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install FFmpeg (Ubuntu)
        if: matrix.os == 'ubuntu'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version

      - name: Install FFmpeg (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install ffmpeg
          ffmpeg -version

      - name: Install FFmpeg (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          choco install ffmpeg -y
          ffmpeg -version

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-build-standalone-${{ matrix.os }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}
          restore-keys: |
            zig-build-standalone-${{ matrix.os }}-

      - name: Build application (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: zig build -Dno-embed-ffmpeg=true

      - name: Build application (Unix)
        if: matrix.os != 'windows'
        shell: bash
        run: zig build -Dno-embed-ffmpeg=true

      - name: Test video generation
        shell: bash
        run: |
          mkdir -p test-media
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen-standalone.exe video --duration 1 --width 320 --height 240 --output test-media/test_video.mp4
          else
            ./zig-out/bin/media-gen-standalone video --duration 1 --width 320 --height 240 --output test-media/test_video.mp4
          fi
          if [[ ! -f test-media/test_video.mp4 ]]; then
            echo "Video file was not created"
            exit 1
          fi
          file_size=$(stat -f%z test-media/test_video.mp4 2>/dev/null || stat -c%s test-media/test_video.mp4)
          if [[ $file_size -lt 1000 ]]; then
            echo "Video file is too small: $file_size bytes"
            exit 1
          fi
          echo "✅ Standalone video test passed: $file_size bytes"

      - name: Test audio generation
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen-standalone.exe audio --duration 1 --sample-rate 22050 --output test-media/test_audio.mp3
          else
            ./zig-out/bin/media-gen-standalone audio --duration 1 --sample-rate 22050 --output test-media/test_audio.mp3
          fi
          if [[ ! -f test-media/test_audio.mp3 ]]; then
            echo "Audio file was not created"
            exit 1
          fi
          file_size=$(stat -f%z test-media/test_audio.mp3 2>/dev/null || stat -c%s test-media/test_audio.mp3)
          if [[ $file_size -lt 1000 ]]; then
            echo "Audio file is too small: $file_size bytes"
            exit 1
          fi
          echo "✅ Standalone audio test passed: $file_size bytes"

      - name: Test help command
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./zig-out/bin/media-gen-standalone.exe help
          else
            ./zig-out/bin/media-gen-standalone help
          fi

  # ==========================================================================
  # Performance Tests - Bundled Edition
  # ==========================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.test_type == 'all' ||
      github.event.inputs.test_type == 'performance' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_run'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache FFmpeg binaries
        uses: actions/cache@v4
        with:
          path: src/vendor/ffmpeg
          key: ffmpeg-binaries-${{ runner.os }}-v1
          restore-keys: |
            ffmpeg-binaries-${{ runner.os }}-

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.1

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            .zig-cache
            zig-out
          key: zig-build-perf-${{ runner.os }}-${{ hashFiles('build.zig', 'src/**/*.zig') }}
          restore-keys: |
            zig-build-perf-${{ runner.os }}-

      - name: Build application (bundled, optimized)
        run: zig build -Doptimize=ReleaseFast

      - name: Performance test - Video generation
        run: |
          mkdir -p test-media
          echo "Testing video generation performance (bundled)..."
          time ./zig-out/bin/media-gen video --duration 3 --width 480 --height 360 \
            --output test-media/perf_test_video.mp4
          file_size=$(stat -c%s test-media/perf_test_video.mp4)
          echo "Generated video size: $file_size bytes"

      - name: Performance test - Audio generation
        run: |
          echo "Testing audio generation performance (bundled)..."
          time ./zig-out/bin/media-gen audio --duration 3 --sample-rate 22050 --output test-media/perf_test_audio.mp3
          file_size=$(stat -c%s test-media/perf_test_audio.mp3)
          echo "Generated audio size: $file_size bytes"

      - name: Install system FFmpeg for standalone comparison
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Build standalone edition (optimized)
        run: zig build -Dno-embed-ffmpeg=true -Doptimize=ReleaseFast

      - name: Performance test - Standalone comparison
        run: |
          echo "Testing standalone edition performance..."
          time ./zig-out/bin/media-gen-standalone video --duration 3 --width 480 --height 360 \
            --output test-media/perf_test_video_standalone.mp4
          time ./zig-out/bin/media-gen-standalone audio --duration 3 --sample-rate 22050 \
            --output test-media/perf_test_audio_standalone.mp3
          echo "✅ Performance tests completed"
